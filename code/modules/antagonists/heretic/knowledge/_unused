/datum/heretic_knowledge/blade_dance
	name = "Dance of the Brand"
	// desc is set in New()
	gain_text = "Having the prowess to wield such a thing requires great dedication and terror."
	next_knowledge = list(
		/datum/heretic_knowledge/limited_amount/risen_corpse,
		/datum/heretic_knowledge/mark/blade_mark,
		/datum/heretic_knowledge/codex_cicatrix,
		/datum/heretic_knowledge/armor,
	)
	cost = 1
	route = PATH_BLADE
	/// The cooldown between blocks
	var/cooldown = 20 SECONDS
	/// Whether the block is ready or not. Used instead of cooldowns, so we can give feedback when it's ready again
	var/block_ready = TRUE

/datum/heretic_knowledge/blade_dance/New()
	. = ..()
	desc = "Allows you flawlessly block strikes against you while wielding a Darkened Blade. \
		This effect can only trigger once every [cooldown / 10] seconds, and requires a Darkened Blade in either of your hands."

/datum/heretic_knowledge/blade_dance/on_gain(mob/user)
	RegisterSignal(user, COMSIG_HUMAN_CHECK_SHIELDS, .proc/on_shield_reaction)

/datum/heretic_knowledge/blade_dance/on_lose(mob/user)
	UnregisterSignal(user, COMSIG_HUMAN_CHECK_SHIELDS)

/datum/heretic_knowledge/blade_dance/proc/on_shield_reaction(
	mob/living/carbon/human/source,
	atom/movable/hitby,
	damage = 0,
	attack_text = "the attack",
	attack_type = MELEE_ATTACK,
	armour_penetration = 0,
)

	SIGNAL_HANDLER

	if(!block_ready)
		return

	if(source.incapacitated(IGNORE_GRAB))
		return

	// Let's check their held items to see if we can do a block
	var/obj/item/main_hand = source.get_active_held_item()
	var/obj/item/off_hand = source.get_inactive_held_item()
	// This is the item that ends up doing the "blocking" (flavor)
	var/obj/item/blocking_with

	// First we'll check if the offhand is valid
	if(!QDELETED(off_hand) && istype(off_hand, /obj/item/melee/sickly_blade))
		blocking_with = off_hand

	// Then we'll check the mainhand
	// We do mainhand second, because we want to prioritize it over the offhand
	if(!QDELETED(main_hand) && istype(main_hand, /obj/item/melee/sickly_blade))
		blocking_with = main_hand

	// No valid item in either slot? No block
	if(!blocking_with)
		return

	// If we made it here, the block is successful!
	playsound(get_turf(source), 'sound/weapons/parry.ogg', 100, TRUE)
	source.balloon_alert(source, "blade barrier used")
	source.visible_message(
		span_warning("[source] effortlessly swats away [attack_text] with [source.p_their()] [blocking_with.name][blocking_with == off_hand ? " in [source.p_their()] offhand":""]!"),
		span_warning("You effortlessly swat away [attack_text] with your [blocking_with.name][blocking_with == off_hand ? " in your offhand":""]!"),
		span_hear("You hear a clink."),
	)

	block_ready = FALSE
	addtimer(CALLBACK(src, .proc/reset_block, source), cooldown)

	return SHIELD_BLOCK

/datum/heretic_knowledge/blade_dance/proc/reset_block(mob/living/carbon/human/source)
	block_ready = TRUE
	source.balloon_alert(source, "blade barrier ready")
